<p align="center">
  <img src="ASWF/logos/rawtoaces-horizontal-color.png">
</p>

[![CI](https://github.com/AcademySoftwareFoundation/rawtoaces/actions/workflows/ci.yml/badge.svg)](https://github.com/AcademySoftwareFoundation/rawtoaces/actions/workflows/ci.yml)
[![Code scanning â€“ CodeQL](https://github.com/AcademySoftwareFoundation/rawtoaces/actions/workflows/github-code-scanning/codeql/badge.svg)](https://github.com/AcademySoftwareFoundation/rawtoaces/actions/workflows/github-code-scanning/codeql)
[![codecov](https://codecov.io/gh/AcademySoftwareFoundation/rawtoaces/branch/main/graph/badge.svg)](https://codecov.io/gh/AcademySoftwareFoundation/rawtoaces)

## Table of Contents
1. [Introduction](#introduction)
2. [Package Contents](#package-contents)
3. [Prerequisites](#prerequisites)
4. [Installation](#installation)
5. [Usage](#usage)
6. [Known Issues](#known-issues)
7. [Installation for Redhat](#installation-for-redhat)
8. [License](#license)

## Introduction
The RAW to ACES Utility or `rawtoaces`, is a software package that converts digital camera RAW files to ACES container files containing image data encoded according to the Academy Color Encoding Specification (ACES) as specified in [SMPTE 2065-1](https://pub.smpte.org/pub/st2065-1/st2065-1-2021.pdf).  This is accomplished through one of two methods.

1. CameraRAW RGB data (generated by libraw) is converted to ACES by calculating an Input Device Transform (IDT) based on the camera's sensitivity and a light source.

2. CameraRAW RGB data (generated by libraw) is converted to ACES by calculating an RGB to XYZ matrix using information included in `libraw` and metadata found in the RAW file.

The output image complies with the ACES Container specification [(SMPTE S2065-4)](https://pub.smpte.org/pub/st2065-4/st2065-4-2023.pdf).

## Package Contents

The source code contains the following:

* [`build_scripts/`](./build_scripts) - Helper scripts for installing dependencies
* [`cmake/`](./cmake) - CMake modules for locating dependencies (e.g., `libraw`)
* [`config/`](./config) - CMake configuration files
* [`docs/`](./docs) - Credits and changes information
* [`include/`](./include) - Public header files for the `rawtoaces` library
* [`src/`](./src) - Source code for the core library, utility library, and the command line tool
* [`unittest/`](./unittest) - Unit tests for `rawtoaces`

## Prerequisites

To build `rawtoaces` you would need to satisfy these dependencies:

| Library          | Min Version| Purpose  | Link to installation instruction |
| -------          | -----------| -------- | -------------------------------- |
| `cmake`          | `3.12`     | | [CMake download](https://cmake.org/download/)|
| `ceres`          | `1.12.0`   | Ceres Solver is an open source library for solving Non-linear Least Squares problems with bounds constraints and unconstrained optimization problems. It processes non-linear regression for rawtoaces.  | [Ceres Solver installation](http://ceres-solver.org/installation.html)|
| `boost`          | `1.76.0`   | Boost has multiple C++ libraries that support tasks related to linear algebra, multithreading, image processing, unit testing, etc. It unit testing for rawtoaces. | [Boost download](http://www.boost.org/) |
| `OpenImageIO`    | `3.0`      | OpenImageIO is an open source library providing vast functionality for image processing. rawtoaces relies on OpenImageIO for reading raw files, saving AcesContainer files, and also all pixel operations.  | [OpenImageIO installation](https://github.com/AcademySoftwareFoundation/OpenImageIO/blob/main/INSTALL.md) |


### MacOS

Install homebrew if not already installed
	
```sh
$ /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
```

```sh
$ brew install cmake ceres-solver imath boost  
```

### Linux

```sh
$ sudo apt-get -f cmake
$ sudo apt-get -f install \
    libboost-dev \
    libboost-system-dev \
    libboost-test-dev \
    libceres-dev
```

### RedHat

```sh
$ sudo yum install cmake
$ sudo yum install eigen3-devel ceres-solver-devel boost-devel
```

### Windows

Install cmake first via [installer](https://cmake.org/download/) or with Chocolatey:

```sh
$ choco install cmake
```

```sh
$ build_scripts/install_aces_container.bash
$ vcpkg install \
    ceres:x64-windows \
    boost-system:x64-windows \
    boost-foreach:x64-windows \
    boost-test:x64-windows
```

## Build and Install

#### From Source
	
From the root source directory:
	
```sh
$ git clone https://github.com/AcademySoftwareFoundation/rawtoaces
$ cd rawtoaces
$ cmake -S . -B build
$ cmake --build build
$ sudo cmake --install build # Optional if you want it to be accessible system wide
```

The default process will install `librawtoaces_core_${rawtoaces_version}.dylib` and `librawtoaces_util_${rawtoaces_version}.dylib` to `/usr/local/lib`, a few header files to `/usr/local/include/rawtoaces` and a number of data files into `/usr/local/include/rawtoaces/data`.

#### Docker

Assuming you have [Docker](https://www.docker.com/) installed, installing and
running rawtoaces is relatively straightforward except for the compilation of
*ceres-solver* that requires a significant amount of memory, well over
the 2Go that Docker allocates by default. Thus you will need to increase the
memory in Docker preferences: Preferences --> Resources --> Advanced, 8Go
should be enough.

* From the root source directory, build the container:
 
	```sh
	$ docker build -f "Dockerfile" -t rawtoaces:latest "."
	```

* Then to run it from a directory with images:

	```sh
	$ docker run -it --rm -v $PWD:/tmp -w /tmp rawtoaces:latest rawtoaces IMG_1234.CR2
	```
	
## Usage

### Overview

`rawtoaces` uses one of three methods to convert RAW image files to ACES.

1. Camera spectral sensitivities and illuminant spectral power distributions
2. Camera file metadata
3. Camera data included in the `libraw` software

The preferred, and most accurate, method of converting RAW image files to ACES is to use camera spectral sensitivities and illuminant spectral power distributions, if available.  If spectral sensitivity data is available for the camera, `rawtoaces` uses the method described in Academy document [P-2013-001](http://j.mp/P-2013-001) (.pdf download).

While preferred, camera spectral sensitivity data is not commonly known to general users. When that is the case, `rawtoaces` can use either the metadata embedded in the camera file or camera data included in `libraw` to approximate a conversion to ACES.

### Help message

A help message with a description of all command line options can be obtained by typing the following command:
	
    Rawtoaces converts raw image files from a digital camera to the Academy Colour Encoding System (ACES) compliant images.
    The process consists of two parts:
    - the colour values get converted from the camera native colour space to the ACES AP0 (see "SMPTE ST 2065-1"), and 
    - the image file gets converted from the camera native raw file format to the ACES Image Container file format (see "SMPTE ST 2065-4").

    Rawtoaces supports the following white-balancing modes:
    - "metadata" uses the white-balancing coefficients from the raw image file, provided by the camera.
    - "illuminant" performs white balancing to the illuminant, provided in the "--illuminant" parameter. The list of the supported illuminants can be seen using the "--list-illuminants" parameter. This mode requires spectral sensitivity data for the camera model the image comes from. The list of cameras such data is available for, can be seen using the "--list-cameras" parameter. In addition to the named illuminants, which are stored under ${RAWTOACES_DATA_PATH}/illuminant, blackbody illuminants of a given colour temperature can me used (use 'K' suffix, i.e. '3200K'), as well as daylight illuminants (use the 'D' prefix, i.e. 'D65').
    - "box" performs white-balancing to make the given region of the image appear neutral gray. The box position (origin and size) can be specified using the "--wb-box" parameter. In case no such parameter provided, the whole image is used for white-balancing.
    - "custom" uses the custom white balancing coefficients provided using the -"custom-wb" parameter.

    Rawtoaces supports the following methods of color matrix computation:
    - "auto" (recommended) first tries the "spectral" method if spectral sensitivity data for the camera is available. If not, it falls back to "metadata". This avoids failures when spectral data is missing while still using the most accurate method when possible.
    - "spectral" uses the camera sensor's spectral sensitivity data to compute the optimal matrix. This mode requires spectral sensitivity data for the camera model the image comes from. The list of cameras such data is available for, can be seen using the "--list-cameras" parameter.
    - "metadata" uses the matrix (matrices) contained in the raw image file metadata. This mode works best with the images using the DNG format, as the DNG standard mandates the presense of such matrices.
    - "Adobe" uses the Adobe coefficients provided by LibRaw. 
    - "custom" uses a user-provided color conversion matrix. A matrix can be specified using the "--custom-mat" parameter.

    The paths rawtoaces uses to search for the spectral sensitivity data can be specified in the RAWTOACES_DATA_PATH environment variable.

    Usage: 
        rawtoaces --wb-method METHOD --mat-method METHOD [PARAMS] path/to/dir/or/file ...
    Examples: 
        rawtoaces --wb-method metadata --mat-method metadata raw_file.dng
        rawtoaces --wb-method illuminant --illuminant 3200K --mat-method spectral raw_file.cr3

        --help                          Print help message
        --version                       Print version and exit
        --wb-method STR                 White balance method. Supported options: metadata, illuminant, box, custom. (default: metadata)
        --mat-method STR                IDT matrix calculation method. Supported options: auto, spectral, metadata, Adobe, custom. (default: auto)
        --illuminant STR                Illuminant for white balancing. (default = D55)
        --wb-box X Y W H                Box to use for white balancing. (default = (0,0,0,0) - full image)
        --custom-wb R G B G             Custom white balance multipliers.
        --custom-mat Rr Rg Rb Gr Gg Gb Br Bg Bb
                                        Custom camera RGB to XYZ matrix.
        --custom-camera-make STR        Camera manufacturer name to be used for spectral sensitivity curves lookup. If present, overrides the value stored in the file metadata.
        --custom-camera-model STR       Camera model name to be used for spectral sensitivity curves lookup. If present, overrides the value stored in the file metadata.
        --headroom VAL                  Highlight headroom factor. (default: 6)
        --scale VAL                     Additional scaling factor to apply to the pixel values. (default: 1)
    General options:
        --overwrite                     Allows overwriting existing files. If not set, trying to write to an existing file will generate an error.
        --data-dir STR                  Directory containing rawtoaces spectral sensitivity and illuminant data files. Overrides the default search path and the RAWTOACES_DATA_PATH environment variable.
        --output-dir STR                The directory to write the output files to. This gets applied to every input directory, so it is better to be used with a single input directory.
        --create-dirs                   Create output directories if they don't exist.
        --disable-cache                 Disable the colour space transform cache.
    Raw conversion options:
        --auto-bright                   Enable automatic exposure adjustment.
        --adjust-maximum-threshold VAL  Automatically lower the linearity threshold provided in the metadata by this scaling factor. (default: 0.75)
        --black-level VAL               If >= 0, override the black level. (default: -1)
        --saturation-level VAL          If not 0, override the level which appears to be saturated after normalisation. (default: 0)
        --chromatic-aberration R B      Red and blue scale factors for chromatic aberration correction. The value of 1 means no correction. (default: 1)
        --half-size                     If present, decode image at half size resolution.
        --highlight-mode VAL            0 = clip, 1 = unclip, 2 = blend, 3..9 = rebuild. (default: 0)
        --crop-box X Y W H              Apply custom crop. If not present, the default crop is applied, which should match the crop of the in-camera JPEG.
        --crop-mode STR                 Cropping mode. Supported options: 'none' (write out the full sensor area), 'soft' (write out full image, mark the crop as the display window), 'hard' (write out only the crop area). (default: soft)
        --flip VAL                      If not 0, override the orientation specified in the metadata. 1..8 correspond to EXIF orientation codes (3 = 180 deg, 6 = 90 deg CCW, 8 = 90 deg CW.) (default: 0)
        --denoise-threshold VAL         Wavelet denoising threshold (default: 0)
        --demosaic STR                  Demosaicing algorithm. Supported options: 'linear', 'VNG', 'PPG', 'AHD', 'DCB', 'AHD-Mod', 'AFD', 'VCD', 'Mixed', 'LMMSE', 'AMaZE', 'DHT', 'AAHD', 'AHD'. (default: AHD)
    Benchmarking and debugging:
        --list-cameras                  Shows the list of cameras supported in spectral mode.
        --list-illuminants              Shows the list of illuminants supported in spectral mode.
        --use-timing                    Log the execution time of each step of image processing.
        --verbose                       (-v) Print progress messages. Repeated -v will increase verbosity.
		
### Command line parameters changes since version v1.x:

The command line parser has been rewritten since v1.x, so there are some changes to the command line parameters. See below for some examples of how to use different white balance and matrix methods:

#### White balance methods:
| old | new |
|-----|-----|
| rawtoaces --wb-method 0            | rawtoaces --wb-method metadata                      |
| rawtoaces --wb-method 1 d65        | rawtoaces --wb-method illuminant --illuminant d65   |
| rawtoaces --wb-method 2            | rawtoaces --wb-method box                           |
| rawtoaces --wb-method 3 \<x y w h> | rawtoaces --wb-method box --wb-box \<x y w h>       |
| rawtoaces --wb-method 4 \<r g b g> | rawtoaces --wb-method custom --custom-wb \<r g b g> |

#### Matrix methods:
| old | new |
|-----|-----|
| rawtoaces --mat-method 0                                            | rawtoaces --mat-method spectral                                                   |
| rawtoaces --mat-method 1                                            | rawtoaces --mat-method metadata                                                   |
| rawtoaces --mat-method 2                                            | rawtoaces --mat-method Adobe                                                      |
| rawtoaces --mat-method 3 \<m1r m1g m1b m2r m2g m2b m3r m3g m3b>     | rawtoaces --mat-method custom --custom-mat \<m1r m1g m1b m2r m2g m2b m3r m3g m3b> |

#### Other command line parameters:
| old | new |
|-----|-----|
| -c 0.8          | --adjust-maximum-threshold 0.8 |
| -C 1.2 1.1      | --chromatic-aberration 1.2 1.1 |
| -k 512          | --black-level 512              |
| -S 15000        | --saturation-level 15000       |
| -n 1.5          | --threshold 1.5                |
| -H 1            | --highlight-mode 1             |
| -W              | --auto-bright                  |
| -b 1.1          | --scale 1.1                    |
| -q 3            | --demosaic AHD                 |
| -f 0            | --flip 0                       |
| -h              | --half-size                    |
| -B \<x y w h>   | --crop-box \<x y w h>          |
| -d              | --use-timing                   |
| --valid-illums  | --list-illuminants             |
| --valid-cameras | --list-cameras                 |

#### Other changes
- rawtoaces will not overwrite output files unless executed with "--overwrite"
- custom output directory can be specified with "--output-dir", the output directory can be either absolute, or considered relative to each input directory
- missing output directories provided in "--output-dir" will be created automatically if executed with "--create-dirs"
        
### RAW conversion options
	
In most cases the default values for all "RAW conversion options" should be sufficient.  Please see the help menu for details of the RAW conversion options.

### Conversion using spectral sensitivities

If spectral sensitivity data for your camera is included with `rawtoaces` then the following command will convert your RAW file to ACES using that information.

	$ rawtoaces input.raw
	
This command is equivalent to :
	
	$ rawtoaces --wb-method metadata --mat-method auto input.raw
	
To process mutiple raw files, you can try:
	
	$ rawtoaces input1.raw input2.raw
	
To batch-process raw files in a directory, you can try:

	$ rawtoaces input_dir
	
To batch-process raw files from multiple directories, you can try:
	
	$ rawtoaces input_dir1 input_dir2
	
This is the preferred method as camera white balance gain factors and the RGB to ACES conversion matrix will be calculated using the spectral sensitivity data from your camera. This provides the most accurate conversion to ACES. 

By default, `rawtoaces` will determine the adopted white by finding the set of white balance gain factors calculated from spectral sensitivities closest to the "As Shot" (aka Camera Multiplier) white balance gain factors included in the RAW file metadata. This default behavior can be overridden by including the desired adopted white name after the white balance method. The following example will use the white balance gain factors calculated from spectral sensitivities for D60.

	$ rawtoaces --wb-method illuminant --illuminant D60 --mat-method spectral input.raw
	
You can use the environment variable of `RAWTOACES_DATA_PATH` to specify the repository for your own datasets. If you have spectral sensitivity data for your camera but it is not included with `rawtoaces` you may place that data in `/usr/local/include/rawtoaces/data/camera` or place the data in the folder pointed by `RAWTOACES_DATA_PATH`. The rawtoaces versions prior to v1.1 used the environment variable `AMPAS_DATA_PATH`, the old name is still supported for backward compatibility. If both variables are present, `RAWTOACES_DATA_PATH` takes priority.

	
#### Spectral Datasets

The spectral data are located in a separate repository [rawtoaces-data](https://github.com/AcademySoftwareFoundation/rawtoaces-data).
The build scripts of rawtoaces will fetch and install the data automatically. Please refer to that repository for the information on the data usage and schema.

### Conversion using camera file metadata

In lieu of spectral sensitivity data, camera metadata can be used to convert RAW files to ACES. This includes the camera multiplier white balance gains and any RGB to XYZ matrix included. The RGB to XYZ matrix included in the metadata will be used to calculate the final RGB to ACES matrix used for conversion. The accuracy of this method is dependent on the camera manufacturer writing correct metadata into their RAW files.

The following commands will convert RAW to ACES using the camera file metadata for both white balance and the RGB to XYZ matrix.

	$ rawtoaces --wb-method metadata --mat-method metadata input.raw
	
### Conversion using camera data included in LibRaw

`libraw` includes matrices for a wide range of cameras which may provide a reasonable basis for conversion from RGB to ACES. These matrices were calculated by Adobe and are often referred to as the Adobe coefficients. To use these built-in matrices the following command may be used.
	
	$ rawtoaces --mat-method Adobe
	
`libraw` also provides a few other methods for calculating white balance, including averaging the entire image, averaging a specified box within the image, or explicitly specifying the white balance gain factors to be used. These options can be utilized by using a `--wb-method` value of 'box', or 'custom' as desired, see examples above.

## Known Issues

For a list of currently known issues see the [issues list](https://github.com/AcademySoftwareFoundation/rawtoaces/issues) in github. Please add any issue found to the github list.

## Installation for Redhat

Please follow the steps given in the docx files RAWtoACES_CentOS7.docx and RAWtoACES_CentOS7_noyum.docx with yum and without yum respectively.
